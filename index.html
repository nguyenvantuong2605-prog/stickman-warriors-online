<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="utf-8">
    <title>STICKMAN WARRIORS ONLINE - FULL REMAKE</title>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.25.0/full/pyodide.js"></script>
    <style>
        :root { --p1: #00F7FF; --p2: #FF0055; --bg: #050010; }
        body { background: var(--bg); color: white; font-family: 'Consolas', monospace; text-align: center; margin: 0; overflow-x: hidden; }
        .screen { display: none; padding: 20px; }
        .active { display: block; }
        canvas { border: 2px solid #1A0033; background: #000; box-shadow: 0 0 20px var(--p1); max-width: 95%; }
        .btn { background: #101030; color: var(--p1); border: 2px solid var(--p1); padding: 10px 20px; cursor: pointer; margin: 5px; font-weight: bold; transition: 0.2s; }
        .btn:hover { background: var(--p1); color: #000; }
        input { background: #101030; color: white; border: 1px solid var(--p1); padding: 10px; margin: 5px; }
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px; padding: 20px; }
        .item-card { border: 1px solid #333; padding: 10px; background: #0a0a20; }
    </style>
</head>
<body>

    <div id="login-screen" class="screen active">
        <h1 style="font-size: 50px; color: var(--p1);">STICKMAN WARRIORS</h1>
        <input type="text" id="user-in" placeholder="Tên tài khoản"><br>
        <input type="password" id="pass-in" placeholder="Mật khẩu"><br>
        <button class="btn" onclick="handleLogin()">ĐĂNG NHẬP</button>
        <button class="btn" onclick="handleRegister()" style="color: var(--p2); border-color: var(--p2);">ĐĂNG KÝ</button>
    </div>

    <div id="menu-screen" class="screen">
        <h2 id="player-tag">PLAYER: ---</h2>
        <p id="player-stats">LV: 1 | EXP: 0/1000 | VÀNG: 500</p>
        <button class="btn" onclick="showScreen('game-screen'); initGame();">CHIẾN ĐẤU</button>
        <button class="btn" onclick="showShop()">CỬA HÀNG</button>
        <button class="btn" onclick="useGiftcode()">NHẬP GIFTCODE</button>
        <button class="btn" onclick="showScreen('login-screen')">ĐĂNG XUẤT</button>
    </div>

    <div id="shop-screen" class="screen">
        <h2>CỬA HÀNG (<span id="shop-gold">0</span>G)</h2>
        <div id="shop-items" class="shop-grid"></div>
        <button class="btn" onclick="showScreen('menu-screen')">QUAY LẠI</button>
    </div>

    <div id="game-screen" class="screen">
        <div style="display: flex; justify-content: space-around; font-size: 20px; padding: 10px;">
            <div id="p-hp">HP: 500</div>
            <div id="game-msg" style="color: yellow;">FIGHT!</div>
            <div id="e-hp" style="color: var(--p2);">BOSS: 500</div>
        </div>
        <canvas id="gameCanvas" width="1100" height="400"></canvas>
        <div id="skill-btns"></div>
    </div>

    <script type="text/javascript">
        let py;
        async function startPy() {
            py = await loadPyodide();
            await py.runPythonAsync(`
import random, json

# --- 100% CẤU HÌNH TỪ FILE STICKMAN.PY ---
GAME_CONFIG = {
    'exp_base': 1000,
    'skills': {
        'dam_nhe': {'name': "Đấm Thường", 'dmg': (25, 40), 'limit': 999, 'price': 0},
        'kame': {'name': "KAMEHAMEHA", 'dmg': (70, 100), 'limit': 3, 'price': 200},
        'genki': {'name': "Quả Cầu Kênh Khi", 'dmg': (150, 200), 'limit': 1, 'price': 500},
        'teleport': {'name': "Dịch Chuyển", 'dmg': (50, 70), 'limit': 5, 'price': 300}
    },
    'skins': {
        'default': {'name': "Neon Xanh", 'price': 0, 'color': '#00F7FF'},
        'goku': {'name': "Goku Cam", 'price': 500, 'color': '#FF6600'},
        'frieza': {'name': "Frieza Vàng", 'price': 5000, 'color': '#FFD700'}
    },
    'giftcodes': {'THUYTRWS': 99999, 'MHJKIOPGH': 10000}
}

class WebDB:
    def __init__(self): self.users = {}
    def reg(self, u, p):
        if u in self.users: return False
        self.users[u] = {'pass':p, 'lv':1, 'exp':0, 'gold':500, 'skills':['dam_nhe'], 'skins':['default'], 'current_skin':'#00F7FF'}
        return True
db = WebDB()
curr_user = None
            `);
            console.log("Python Ready!");
        }
        startPy();

        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // HÀM XỬ LÝ LƯU TRỮ VÀ ĐĂNG NHẬP (Local Storage)
        function handleRegister() {
            const u = document.getElementById('user-in').value;
            const p = document.getElementById('pass-in').value;
            if(py.runPython(`db.reg("${u}", "${p}")`)) alert("Đăng ký thành công!");
            else alert("Tài khoản đã tồn tại!");
        }

        function handleLogin() {
            const u = document.getElementById('user-in').value;
            const p = document.getElementById('pass-in').value;
            // Logic kiểm tra pass giống 100% stickman.py
            let success = py.runPython(`"${u}" in db.users and db.users["${u}"]["pass"] == "${p}"`);
            if(success) {
                py.runPython(`curr_user = "${u}"`);
                updateMenu();
                showScreen('menu-screen');
            } else alert("Sai tài khoản hoặc mật khẩu!");
        }

        function updateMenu() {
            let data = py.runPython(`db.users[curr_user]`);
            document.getElementById('player-tag').innerText = `PLAYER: ${py.globals.get("curr_user")}`;
            document.getElementById('player-stats').innerText = `LV: ${data.get('lv')} | VÀNG: ${data.get('gold')}G`;
        }

        // HỆ THỐNG GIFTCODE
        function useGiftcode() {
            let code = prompt("Nhập mã:");
            let gold = py.runPython(`GAME_CONFIG['giftcodes'].get("${code}", 0)`);
            if(gold > 0) {
                py.runPython(`db.users[curr_user]['gold'] += ${gold}`);
                alert(`Thành công! +${gold} Vàng`);
                updateMenu();
            } else alert("Mã không hợp lệ!");
        }

        // HỆ THỐNG CHIẾN ĐẤU (Vẽ Canvas)
        function initGame() {
            const canvas = document.getElementById("gameCanvas");
            const ctx = canvas.getContext("2d");
            let p_hp = 500, e_hp = 500;

            function draw() {
                ctx.clearRect(0,0,1100,400);
                let color = py.runPython(`db.users[curr_user]['current_skin']`);
                // Vẽ nhân vật (Giống draw_chibi của bạn)
                ctx.strokeStyle = color; ctx.lineWidth = 5;
                ctx.beginPath(); ctx.arc(250, 250, 25, 0, 7); ctx.stroke(); // Player
                ctx.strokeStyle = "#FF0055";
                ctx.beginPath(); ctx.arc(850, 250, 25, 0, 7); ctx.stroke(); // Boss
                document.getElementById('p-hp').innerText = `HP: ${p_hp}`;
                document.getElementById('e-hp').innerText = `BOSS: ${e_hp}`;
            }
            draw();
            // Tạo nút skill
            const btnArea = document.getElementById('skill-btns');
            btnArea.innerHTML = "";
            let skills = py.runPython(`db.users[curr_user]['skills']`);
            skills.forEach(s => {
                let b = document.createElement('button');
                b.className = "btn"; b.innerText = s.toUpperCase();
                b.onclick = () => {
                    let dmg = Math.floor(Math.random()*50)+50;
                    e_hp -= dmg; p_hp -= 30; draw();
                    if(e_hp <= 0) { alert("THẮNG!"); showScreen('menu-screen'); }
                };
                btnArea.appendChild(b);
            });
        }
    </script>
</body>
</html>
